<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Free-draw on Image using Three.js</title>
  <!-- Showing that it doesn't work. Throwing everything into the texture loader. -->
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    canvas {
      display: block;
      pointer-events: none;
    }
  </style>
</head>
<body>
<script src="/build/three.js"></script>
<script>
  console.log(THREE.REVISION);
  let isDrawing = false;

  let scene = new THREE.Scene();

  let camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
  camera.position.z = 10;

  let renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  new THREE.TextureLoader().load("/textures/images/cut-the-rope.jpg", function(texture) {
    // create a plane geometry with a texture
    let planeGeometry = new THREE.PlaneGeometry(10, 10, 1, 1);
    let planeMaterial = new THREE.MeshBasicMaterial({ map: texture });
    let plane = new THREE.Mesh(planeGeometry, planeMaterial);
    scene.add(plane);

    let canvas = document.createElement("canvas");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let context = canvas.getContext("2d");

    let canvasTexture = new THREE.CanvasTexture(canvas);
    planeMaterial.map = canvasTexture; // todo: because of this

    context.strokeStyle = "#FF0000";
    context.lineWidth = 5;

    function onCanvasMouseDown(event) {
      isDrawing = true;
      let x = event.clientX - canvas.offsetLeft;
      let y = event.clientY - canvas.offsetTop;
      context.beginPath();
      context.moveTo(x, y);
    }

    function onCanvasMouseMove(event) {
      if (isDrawing) {
        let x = event.clientX - canvas.offsetLeft;
        let y = event.clientY - canvas.offsetTop;
        context.lineTo(x, y);
        context.stroke();
        canvasTexture.needsUpdate = true;
      }
    }

    document.addEventListener("mousemove", onCanvasMouseMove);
    document.addEventListener("mousedown", onCanvasMouseDown);

    document.addEventListener("mouseup", function() {
      isDrawing = false;
      context.closePath();
      context.stroke();
    });

  });

  (function render() {
    requestAnimationFrame(render);
    renderer.render(scene, camera);
  })();
</script>
</body>
</html>
