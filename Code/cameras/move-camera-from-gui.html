<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>update-perspective-camera</title>
  <!-- https://discourse.threejs.org/t/how-to-control-camera-position-x-from-dat-gui/27467 -->
  <!-- They rolled their own axis helper: https://jsfiddle.net/fiddleuser01/rezcpgh4/7/ -->
  <style>
    canvas {
      height: 100%;
      width: 100%;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/three@0.129.0/build/three.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.129.0/examples/js/libs/dat.gui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.129.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>

<canvas id='canvasId'></canvas>

<!-- <script type='module'> -->
<script>
  // import * as THREE from '../lib/three-js-129/build/three.module.js';
  // import { GUI } from '../lib/three-js-129/examples/jsm/libs/dat.gui.module.js';
  // import { OrbitControls } from '../lib/three-js-129/examples/jsm/controls/OrbitControls.js';

  const RED = 0xff0000;
  const GREEN = 0x00ff00;
  const BLUE = 0x0000ff;
  const LIMIT = 100;

  let canvas, scene, camera, renderer, testPerspectiveCamera, testPerspectiveCameraHelper;

  function initAxes() {
    function makeAxis(start, finish, material, name) {
      const points = [start, finish];
      const axisGeometry = new THREE.BufferGeometry().setFromPoints(points);
      const newAxis = new THREE.Line(axisGeometry, material);
      newAxis.name = name;
      scene.add(newAxis);
    }

    const xAxisMaterial = new THREE.LineBasicMaterial({color: RED});
    const yAxisMaterial = new THREE.LineBasicMaterial({color: GREEN});
    const zAxisMaterial = new THREE.LineBasicMaterial({color: BLUE});
    makeAxis(new THREE.Vector3(-LIMIT, 0, 0), new THREE.Vector3(LIMIT, 0, 0), xAxisMaterial, 'xAxis');
    makeAxis(new THREE.Vector3(0, -LIMIT, 0), new THREE.Vector3(0, LIMIT, 0), yAxisMaterial, 'yAxis');
    makeAxis(new THREE.Vector3(0, 0, -LIMIT), new THREE.Vector3(0, 0, LIMIT), zAxisMaterial, 'zAxis');
  }

  // Does changing near & far plane of a PerspectiveCamera, via gui, mess up fov? No.
  function initGui() {
    const controls = {
      get near() {
        return testPerspectiveCamera.near;
      },
      set near(value) {
        testPerspectiveCamera.near = value;
        testPerspectiveCamera.updateProjectionMatrix();
        testPerspectiveCameraHelper.update();
      },
      get far() {
        return testPerspectiveCamera.far;
      },
      set far(value) {
        testPerspectiveCamera.far = value;
        testPerspectiveCamera.updateProjectionMatrix();
        testPerspectiveCameraHelper.update();
      },
      get aspect() {
        return testPerspectiveCamera.aspect;
      },
      set aspect(value) {
        testPerspectiveCamera.aspect = value;
        testPerspectiveCamera.updateProjectionMatrix();
        testPerspectiveCameraHelper.update();
      },
      get fov() {
        return testPerspectiveCamera.fov;
      },
      set fov(value) {
        testPerspectiveCamera.fov = value;
        testPerspectiveCamera.updateProjectionMatrix();
        testPerspectiveCameraHelper.update();
      },
      get positionX() {
        return testPerspectiveCamera.position.x;
      },
      set positionX(value) {
        testPerspectiveCamera.position.x = value;
        testPerspectiveCamera.updateMatrixWorld();
      },
      get positionY() {
        return testPerspectiveCamera.position.y;
      },
      set positionY(value) {
        testPerspectiveCamera.position.y = value;
        testPerspectiveCamera.updateMatrixWorld();
      },
      get positionZ() {
        return testPerspectiveCamera.position.z;
      },
      set positionZ(value) {
        testPerspectiveCamera.position.z = value;
        testPerspectiveCamera.updateMatrixWorld();
      }
    };
    // const gui = new GUI();
    const gui = new dat.GUI();
    const perspectiveCameraFolder = gui.addFolder('testPerspectiveCamera');
    perspectiveCameraFolder.add(controls, 'near', 0, 50);
    perspectiveCameraFolder.add(controls, 'far', 0, 200);
    perspectiveCameraFolder.add(controls, 'aspect', 0, 4);
    perspectiveCameraFolder.add(controls, 'fov', 0, 100);
    perspectiveCameraFolder.add(controls, 'positionX', -LIMIT, LIMIT);
    perspectiveCameraFolder.add(controls, 'positionY', -LIMIT, LIMIT);
    perspectiveCameraFolder.add(controls, 'positionZ', -LIMIT, LIMIT);
  }

  function render() {
    renderer.render(scene, camera);
    testPerspectiveCamera.updateMatrixWorld();
    requestAnimationFrame(render);
  }

  function initCamera() {
    camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 1, 10000);
    camera.name = 'camera';
    camera.position.set(60, 40, 150);
    scene.add(camera);
  }

  function initRenderer() {
    renderer = new THREE.WebGLRenderer({canvas: canvas});
    // renderer.shadowMap.enabled = true;
    renderer.setSize(canvas.width, canvas.height, false); // todo:defer until initial doWindowResize
  }

  function initLight() {
    const ambientLight = new THREE.AmbientLight(0xffffff, 1);
    ambientLight.name = 'ambientLight';
    scene.add(ambientLight);
  }

  function initTestPerspectiveCamera() {
    //  fov, aspect, near, far
    testPerspectiveCamera = new THREE.PerspectiveCamera(45, 2, 20, 100);
    testPerspectiveCamera.name = 'testPerspectiveCamera';
    testPerspectiveCamera.position.set(40, 0, 0);
    testPerspectiveCamera.lookAt(0, 100, 0); // lookAt is a method of Object#D
    testPerspectiveCameraHelper = new THREE.CameraHelper(testPerspectiveCamera);
    testPerspectiveCameraHelper.name = 'testPerspectiveCameraHelper';
    testPerspectiveCamera.updateMatrixWorld();
    scene.add(testPerspectiveCameraHelper);
  }

  function listSceneObjects() {
    console.log(`id: ${scene.id}, name: ${scene.name}, parent.id: ${scene?.parent?.id}`);
    for (const obj of scene.children) {
      console.log(`id: ${obj.id}, name: ${obj.name}, parent.id: ${obj.parent.id}`);
    }
  }

  window.onload = function () {
    canvas = document.getElementById('canvasId');
    scene = new THREE.Scene();
    scene.name = 'scene';
    initCamera();
    initRenderer();
    initLight();
    initAxes();
    initTestPerspectiveCamera();
    initGui();
    // new OrbitControls(camera, canvas);
    new THREE.OrbitControls(camera, canvas);
    listSceneObjects();
    console.log(`testPerspectiveCamera: ${JSON.stringify(testPerspectiveCamera)}`);
    console.log(`testPerspectiveCameraHelper.matrixAutoUpdate: ${testPerspectiveCameraHelper.matrixAutoUpdate}`);

    render();
  }
</script>
</body>
</html>
