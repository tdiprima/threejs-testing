<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta content="chrome=1,IE=edge" http-equiv="X-UA-Compatible">
  <title>TEST</title>
  <!-- https://stackoverflow.com/questions/49495681/how-could-we-get-the-pixels-color-of-a-mesh-when-we-click-on-it-using-javascri -->

  <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/three.js/r100/three.min.js"></script> -->

  <script src="/build/three.js"></script>

  <!-- <script src="https://threejs.org/build/three.js"></script> -->
  <!-- <script src="https://threejs.org/examples/js/controls/TrackballControls.js"></script> -->
  <!-- <script src="js/NRRDLoader.js"></script>
  <script src="js/Volume.js"></script>
  <script src="js/VolumeSlice.js"></script> -->
</head>
<body>

<canvas height="500" id="view" style="border: 1px black solid;" width="500"></canvas>

<script>
  /**********************/
  /*   Initialization   */
  /**********************/
  let realClickedCanvasX;
  let realClickedCanvasY;
  let clickCount = 0;

  const pixelBuffer = new Uint8Array(500 * 500 * 4);

  function testPixelBuffer() {
    let i1 = realClickedCanvasX * size.width;
    let i2 = i1 + realClickedCanvasY;
    i2 *= 4;
    let r = pixelBuffer[i2 + 0];
    let g = pixelBuffer[i2 + 1];
    let b = pixelBuffer[i2 + 2];
    let a = pixelBuffer[i2 + 3];
    console.log(i2, r, g, b, a);
  }

  // MOUSE EVENT
  document.getElementById('view').addEventListener('mousedown', onDocumentMouseDown, false);
  function onDocumentMouseDown(event) {
    clickCount++;
    realClickedCanvasX = event.offsetX;
    realClickedCanvasY = event.offsetY;
    console.log(
      `You have clicked on: ${realClickedCanvasY} , ${realClickedCanvasY} it is the click number: ${clickCount}`
    );
    testPixelBuffer();
  }

  const renderer = new THREE.WebGLRenderer({
    canvas: document.getElementById('view'),
    antialias: true,
    alpha: true
  });

  const scene = new THREE.Scene();

  const camera = new THREE.PerspectiveCamera(28, 1, 1, 1000);
  camera.position.z = 50;
  camera.add(new THREE.PointLight(0xffffff, 1));
  scene.add(camera);

  /**********************/
  /* Populate the Scene */
  /**********************/

  // THEIR EXAMPLE
  // const loader = new THREE.NRRDLoader();
  // loader.load('models/nrrd/columnasegmentado01.nrrd', volume => {
  //   // z plane
  //   const sliceZ = volume.extractSlice('z', Math.floor(volume.RASDimensions[2] / 4));
  //   scene.add(sliceZ.mesh);
  // });

  const loader = new THREE.TextureLoader();

  // ATTEMPT #1
  // const geometry = new THREE.BoxGeometry(16, 16, 16);
  // loader.load('https://cdn.pixabay.com/photo/2022/05/23/13/16/bird-7216181_1280.jpg', texture => {
  //   const material = new THREE.MeshBasicMaterial({
  //     map: texture
  //   });
  //   const cube = new THREE.Mesh(geometry, material);
  //   scene.add(cube);
  // });

  // ATTEMPT #2
  const imgPath = 'https://cdn.pixabay.com/photo/2022/05/23/13/16/bird-7216181_1280.jpg';
  loader.load(imgPath, texture => {
    let planeMesh = new THREE.Mesh(
      new THREE.PlaneGeometry(texture.image.width, texture.image.height),
      new THREE.MeshBasicMaterial({ map: texture })
    );
    scene.add(planeMesh);
  });

  /**********************/
  /*   Render Function  */
  /**********************/

  const externalTarget = new THREE.WebGLRenderTarget();

  let size = new THREE.Vector2();
  renderer.getSize(size);
  // let size = renderer.getSize();
  externalTarget.setSize(size.width, size.height);

  function render() {
    renderer.render(scene, camera);
    renderer.render(scene, camera, externalTarget);
  }

  render();

  /**********************/
  /*   Animation Loop   */
  /**********************/
  function animate() {
    requestAnimationFrame(animate);
    renderer.readRenderTargetPixels(externalTarget, 0, 0, size.width, size.height, pixelBuffer);
    // controls.update();
  }

  animate();
</script>
</body>
</html>
