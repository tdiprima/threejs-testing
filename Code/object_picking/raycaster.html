<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>object picking</title>
  <!-- http://soledadpenades.com/articles/three-js-tutorials/object-picking/ -->
  <!-- https://stackoverflow.com/questions/27690441/three-js-better-way-of-adding-multiple-cubes-to-a-scene -->
  <link rel="stylesheet" href="raystyle.css">
  <script src="three.min.js"></script>
  <script src="TrackballControls.js"></script>
  <!-- <script src="/build/three.min.js"></script>
  <script src="/jsm/controls/TrackballControls.js"></script> -->
  <script src="draw-coordinate-axes.js"></script>
</head>
<body>

<h1>object picking with three.js - <a href="http://soledadpenades.com/articles/three-js-tutorials/object-picking/">tutorial</a></h1>
<div id="container"></div>

<script>
  window.onload = function() {
    let container = document.getElementById('container'),
      containerWidth,
      containerHeight,
      renderer,
      scene,
      camera,
      objectContainer,
      geom,
      range = 50,
      mouseVector,
      axes,
      controls;

    containerWidth = container.clientWidth;
    containerHeight = container.clientHeight;

    // Set up renderer, scene and camera
    renderer = new THREE.CanvasRenderer();
    renderer.setSize(containerWidth, containerHeight);
    container.appendChild(renderer.domElement);

    renderer.setClearColorHex(0xeeeedd, 1.0);

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(45, containerWidth / containerHeight, 1, 10000);
    camera.position.set(0, 0, range * 2);
    camera.lookAt(new THREE.Vector3(0, 0, 0));

    // Add some cubes to the scene
    geom = new THREE.CubeGeometry(5, 5, 5);

    objectContainer = new THREE.Object3D();
    scene.add(objectContainer);

    // Note! Adding multiple objects into an Object3D
    // instead of adding each object separately into the scene.
    for (let i = 0; i < 100; i++) {
      let grayness = Math.random() * 0.5 + 0.25;
      let mat = new THREE.MeshBasicMaterial({color: grayness});
      let object = new THREE.Mesh(geom, mat);

      object.position.x = range * (0.5 - Math.random());
      object.position.y = range * (0.5 - Math.random());
      object.position.z = range * (0.5 - Math.random());

      object.rotation.set(
        Math.random(),
        Math.random(),
        Math.random()
      ).multiplyScalar(2 * Math.PI);

      object.grayness = grayness; // Huh?

      objectContainer.add(object);
    }

    // Axes
    axes = buildAxes();
    scene.add(axes);

    // Picking stuff
    projector = new THREE.Projector();
    mouseVector = new THREE.Vector3();

    // User interaction
    window.addEventListener('mousemove', onMouseMove, false);
    window.addEventListener('resize', onWindowResize, false);

    controls = new THREE.TrackballControls(camera);
    controls.zoomSpeed = 0.1;

    // And go!
    animate();

    function onMouseMove(e) {
      mouseVector.x = 2 * (e.clientX / containerWidth) - 1;
      mouseVector.y = 1 - 2 * (e.clientY / containerHeight);

      let raycaster = projector.pickingRay(mouseVector.clone(), camera);
      let intersects = raycaster.intersectObjects(objectContainer.children);

      objectContainer.children.forEach(cube => {
        cube.material.color.setRGB(cube.grayness, cube.grayness, cube.grayness);
      });

      for (let i = 0; i < intersects.length; i++) {
        let intersection = intersects[i];
        let obj = intersection.object;

        obj.material.color.setRGB(1.0 - i / intersects.length, 0, 0);
      }
    }

    function onWindowResize(e) {
      containerWidth = container.clientWidth;
      containerHeight = container.clientHeight;
      renderer.setSize(containerWidth, containerHeight);
      camera.aspect = containerWidth / containerHeight;
      camera.updateProjectionMatrix();
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    console.log(`%cTHREE REV: ${THREE.REVISION}`, "color: #ccff00;");

  };
</script>
</body>
</html>
